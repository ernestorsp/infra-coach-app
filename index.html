<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>INFRA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1557ff">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="INFRA">
  <link rel="apple-touch-icon" href="icon-512.png">

  <style>
    html,body{margin:0;padding:0;width:100%;height:100%;background:#000;overflow:hidden}
    iframe{border:0;width:100%;height:100%;display:block;background:#000}
  </style>
</head>
<body>

  <iframe
    id="appFrame"
    allow="camera; microphone; fullscreen"
    referrerpolicy="no-referrer-when-downgrade"
  ></iframe>

  <script>
    const GAS_BASE = "https://script.google.com/macros/s/AKfycbyu4qmUIIylpBGYWsd94k6By9ZhPLFIpAWFUYOo1vgq3oKI1XPanbObpOUQsq-EOCA/exec";
    const frame = document.getElementById("appFrame");

    function getAppParam(){
      const p = new URLSearchParams(location.search);
      const app = (p.get("app") || "coach").toLowerCase();
      if (app === "capture") return "capture";
      if (app === "rescue") return "rescue";
      return "coach";
    }

    function setIframe(app){
      const nextUrl = (app === "capture") ? GAS_BASE : (GAS_BASE + "?app=" + encodeURIComponent(app));
      if (frame.src !== nextUrl) frame.src = nextUrl;
    }

    // ✅ load initial
    setIframe(getAppParam());

    // ✅ internal nav requested by GAS (your dropdown menu with postMessage)
    window.addEventListener("message", (event) => {
      // IMPORTANT: for safety you could check event.origin, but script.google.com origin can vary.
      const data = event.data || {};
      if (data.type !== "AAXPRESS_NAV") return;

      const next = (data.app || "coach").toLowerCase();

      // update URL (nice for back button) but stays same page
      const url = new URL(location.href);
      url.searchParams.set("app", next);
      history.pushState({}, "", url);

      setIframe(next);
    });

    // ✅ support back button in PWA
    window.addEventListener("popstate", () => setIframe(getAppParam()));

    // ✅ SUPER IMPORTANTE (iOS): evita que links dentro del iframe te saquen “por fuera”
    // Si el iframe intenta navegar el top-level, lo forzamos a quedarse en el iframe.
    // (Esto funciona cuando el navegador intenta abrir externo por navegación normal)
    frame.addEventListener("load", () => {
      try {
        const doc = frame.contentDocument;
        if (!doc) return;

        // 1) fuerza base target self dentro del iframe
        let base = doc.querySelector("base");
        if (!base) {
          base = doc.createElement("base");
          doc.head && doc.head.prepend(base);
        }
        base.setAttribute("target", "_self");

        // 2) intercepta clicks en <a> para no abrir afuera
        doc.addEventListener("click", (e) => {
          const a = e.target && e.target.closest ? e.target.closest("a") : null;
          if (!a) return;

          const href = a.getAttribute("href") || "";
          // deja pasar anchors vacíos / # / onclick internos
          if (!href || href === "#" || href.startsWith("javascript:")) return;

          // si es link absoluto a script.google.com, lo abrimos en el iframe
          if (href.startsWith("http")) {
            e.preventDefault();
            frame.src = href;
          }
        }, true);
      } catch (err) {
        // cross-origin: no podemos tocar el DOM del iframe (normal en script.google.com)
        // No pasa nada; tu menú con postMessage es lo principal.
      }
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("sw.js");
    }
  </script>

</body>
</html>
